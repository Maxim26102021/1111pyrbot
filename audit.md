## Шаг 0 — Инвентаризация текущего состояния

### Telegram-бот
- `bot/main.py:40` — Pyrogram бот, выполняет все команды и бизнес-логику.

### Чтение каналов
- `reader/main.py:19` — Pyrogram клиент читает каналы и сохраняет сообщения напрямую в БД.

### Вызовы LLM
- `common/summarize.py:20` — Прямой вызов Google Gemini для генерации дайджеста.
- `bot/main.py:253` — Обработчик бота вызывает `build_digest`, то есть LLM запускается из хэндлера.

### Работа с оплатами
- Не обнаружено (отсутствует сервис/логика для приёма вебхуков).

### Docker/Compose
- `docker-compose.yml` — Содержит сервисы `db`, `redis`, `reader`, `bot`.
- `docker-compose.override.yml` — Уточнение переменных для `bot`.

### База данных и миграции
- `common/db.py:11` — Ленивая миграция при старте приложения.
- `common/sql/001_init.sql` — Скрипт инициализации, не используется в целевой архитектуре.

---

## Проблемы относительно целевой архитектуры

### а) Тяжёлые операции в боте
- `bot/main.py:274-281` — Бот запускает миграции и планировщик, выполняет периодические задачи.
- `bot/main.py:253` — Генерация дайджеста и отправка выполняется внутри процесса бота.

### б) Прямые вызовы LLM из хэндлеров
- `bot/main.py:253` — В обработчике `/digest_now` вызывается `build_digest`, который напрямую обращается к LLM.

### в) Ручное чтение каналов без очередей
- `reader/main.py:129` — Сообщения читаются и складываются в БД напрямую, без постановки задач в очередь.

### г) Отсутствие миграций/инфраструктуры целевой архитектуры
- Нет структуры `services/*`, `libs/core`, `deploy/`.
- Нет явных SQL миграций в формате, описанном в требованиях (сущности `posts`, `summaries`, `digests` и пр. отсутствуют).
- Отсутствуют Celery, Telethon, Aiogram 3.x, FastAPI для payments/summarizer, GitHub Actions под тесты.

---

## Вывод
Текущая реализация — монолитный Pyrogram-бот с прямым доступом к БД и LLM, без очередей и сервисной архитектуры. Для достижения целевой схемы необходим полный рефакторинг по шагам 1–10.
